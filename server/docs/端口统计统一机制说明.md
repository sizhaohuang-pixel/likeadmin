# 端口统计统一机制说明

## 📋 概述

从 v1.9.4 版本开始，系统实现了基于 `package_id` 的统一端口统计机制，替代了原有的基于 `operator_id` 的统计方式，实现了更精确的端口使用追踪和套餐优先级分配。

## 🔄 机制变更

### 旧机制（v1.9.3及之前）
```php
// 基于 operator_id 统计
$usedPorts = AltAccount::where('tenant_id', $tenantId)
    ->where('operator_id', '>', 0)
    ->count();
```

**问题**：
- 无法追踪小号使用的具体套餐
- 无法实现套餐优先级分配
- 多套餐场景下统计不够精确

### 新机制（v1.9.4）
```php
// 基于 package_id 统计
$usedPorts = AltAccount::where('tenant_id', $tenantId)
    ->where('package_id', '>', 0)
    ->count();
```

**优势**：
- 精确追踪每个小号使用的套餐
- 支持套餐优先级分配策略
- 实现真正的多套餐管理

## 🗄️ 数据库变更

### 新增字段
```sql
-- 为小号表添加套餐ID字段
ALTER TABLE `la_alt_account` ADD COLUMN `package_id` int(11) DEFAULT NULL COMMENT '使用的套餐ID' AFTER `operator_id`;

-- 添加索引
ALTER TABLE `la_alt_account` ADD KEY `idx_package_id` (`package_id`);
ALTER TABLE `la_alt_account` ADD KEY `idx_tenant_package` (`tenant_id`, `package_id`);
```

### 字段含义
- `package_id = NULL`: 小号未分配或历史数据
- `package_id > 0`: 小号已分配并记录了使用的套餐

## 🔧 统一服务类

### PortStatisticsService
创建了统一的端口统计服务类，确保所有地方使用相同的统计逻辑：

```php
// 获取租户端口统计
PortStatisticsService::getTenantPortStats($tenantId);

// 获取租户已用端口数
PortStatisticsService::getTenantUsedPorts($tenantId);

// 检查端口可用性
PortStatisticsService::checkPortAvailability($tenantId, $needCount);
```

## 📊 统计逻辑统一

### 涉及的接口和文件
1. **`auth.tenant/lists`**: 租户列表端口统计
2. **`package/lists`**: 套餐列表端口统计
3. **`package/port_pool_status`**: 端口池状态
4. **`alt_account/assign`**: 小号分配端口检查

### 统一前后对比
```php
// 统一前：各处使用不同的统计方式
// TenantLists
$usedPorts = AltAccount::where('operator_id', '>', 0)->count();

// PackageLogic
$usedPorts = AltAccountAssignment::getTenantUsedPorts($tenantId);

// AltAccountLogic
$usedPorts = AltAccount::where('operator_id', '>', 0)->count();

// 统一后：所有地方使用相同的服务
$usedPorts = PortStatisticsService::getTenantUsedPorts($tenantId);
```

## 🎯 套餐优先级分配

### 分配策略
1. **时间优先**: 按 `assign_time` 升序排列套餐
2. **用完再换**: 优先用完早期套餐
3. **精确记录**: 记录每个小号使用的套餐ID

### 分配算法
```php
// 1. 获取套餐按优先级排序
$packages = PackageAssignment::getTenantPackagesByPriority($tenantId);

// 2. 计算各套餐的端口分配详情
$allocationDetails = PackageAssignment::calculatePortAllocationDetails($tenantId, $usedPorts);

// 3. 按优先级分配小号
foreach ($allocationDetails as $detail) {
    if ($detail['port_free'] > 0) {
        // 分配小号到这个套餐
        AltAccount::update([
            'operator_id' => $operatorId,
            'package_id' => $detail['package_id'],
            'update_time' => time()
        ]);
    }
}
```

## 🔍 数据验证

### 验证接口
提供了数据一致性验证接口：

```bash
# 验证单个租户
GET /adminapi/port-validation/validate-tenant-ports?tenant_id=45

# 验证所有租户
GET /adminapi/port-validation/validate-all-tenants
```

### 验证内容
```php
return [
    'package_based_used' => 基于package_id统计,
    'operator_based_used' => 基于operator_id统计,
    'calculated_used' => 按套餐计算统计,
    'is_consistent' => 是否一致,
    'difference' => 差异数量
];
```

## 📈 升级影响

### 兼容性
- **向后兼容**: 保持所有现有API接口不变
- **渐进升级**: 新分配使用新机制，历史数据保持不变
- **数据迁移**: 可选择性地为历史数据设置package_id

### 性能影响
- **查询优化**: 新增索引提升查询性能
- **统一计算**: 避免重复计算，提升效率
- **缓存友好**: 统一的数据结构便于缓存

## 🛠️ 迁移步骤

### 1. 数据库迁移
```sql
-- 执行数据库结构变更
source database/migration_add_package_id_to_alt_account.sql;
```

### 2. 历史数据迁移（可选）
```sql
-- 为历史分配记录设置package_id
UPDATE la_alt_account aa
SET package_id = (
    SELECT pa.id 
    FROM la_package_assignment pa 
    WHERE pa.tenant_id = aa.tenant_id 
    AND pa.status = 1 
    ORDER BY pa.assign_time ASC 
    LIMIT 1
)
WHERE aa.operator_id > 0 
AND aa.package_id IS NULL;
```

### 3. 验证数据一致性
```bash
# 验证迁移结果
GET /adminapi/port-validation/validate-all-tenants
```

## 📝 最佳实践

### 1. 开发规范
- 所有端口统计必须使用 `PortStatisticsService`
- 禁止直接查询 `operator_id` 进行端口统计
- 新功能开发必须考虑套餐优先级

### 2. 数据维护
- 定期验证数据一致性
- 监控套餐使用效率
- 及时处理过期套餐

### 3. 性能监控
- 监控端口统计查询性能
- 关注套餐分配算法效率
- 优化高频查询接口

这个统一机制确保了端口统计的准确性和一致性，为多套餐管理提供了强有力的技术支撑。
