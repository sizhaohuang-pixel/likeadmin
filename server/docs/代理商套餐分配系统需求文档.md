# 代理商套餐分配系统需求文档

## 文档信息
- **创建时间**: 2025-08-25
- **版本**: v1.0
- **项目**: Likeadmin管理系统
- **模块**: 代理商套餐分配系统

## 1. 需求概述

### 1.1 功能描述
代理商套餐分配系统是基于现有代理商和租户管理功能的扩展模块，允许代理商为其下级租户分配包含端口数和到期时间的套餐。

### 1.2 业务背景
- 代理商需要能够灵活地为租户分配端口资源
- 端口资源有时间限制，需要管理到期时间
- 支持多次分配，端口数可叠加但到期时间独立计算

## 2. 功能需求

### 2.1 核心功能
- **套餐分配**: 代理商为下级租户分配端口套餐
- **套餐查询**: 查看租户当前有效套餐和历史记录
- **套餐管理**: 套餐状态管理和到期处理

### 2.2 套餐内容
- **端口数**: 可自由设置数量（正整数）
- **到期时间**: 可自由设置时长（支持天、周、月等时间单位）

### 2.3 权限控制
- **分配权限**: 代理商只能给自己的下级租户分配套餐
- **层级验证**: 基于现有的管理员层级关系（parent_id字段）进行权限验证

## 3. 业务规则

### 3.1 端口数叠加规则
- 同一租户的多次套餐分配，端口数会**累加**
- 计算租户当前有效端口数 = 所有未过期套餐的端口数之和

### 3.2 到期时间不叠加规则
- 每次分配都是独立的套餐记录
- 到期时间不会延长，需要按时间段分别计算有效端口数
- 套餐过期后自动失效，不影响其他套餐

### 3.3 时间段计算示例
**场景**: 
- 第一次分配：8月20日分配50个端口，到期时间9月1日
- 第二次分配：8月21日分配100个端口，到期时间9月15日

**有效端口数计算**:
- 8月20日 - 8月21日：50个端口
- 8月21日 - 9月1日：50 + 100 = 150个端口
- 9月1日 - 9月15日：100个端口（第一次的50个已过期）
- 9月15日之后：0个端口（所有套餐都已过期）

## 4. 功能模块设计

### 4.1 套餐分配模块
#### 4.1.1 功能描述
代理商为下级租户分配端口套餐

#### 4.1.2 操作流程
1. 代理商登录系统
2. 选择要分配套餐的下级租户
3. 输入端口数量（正整数）
4. 设置到期时间
5. 确认分配，系统记录分配信息

#### 4.1.3 验证规则
- 验证操作者为代理商身份
- 验证目标租户为操作者的下级
- 验证端口数为正整数
- 验证到期时间为未来时间

### 4.2 套餐查询模块
#### 4.2.1 租户当前套餐查询
- 查看指定租户当前有效的端口总数
- 显示各套餐的详细信息和剩余时间

#### 4.2.2 套餐分配历史查询
- 查看代理商的分配记录
- 支持按时间、租户等条件筛选

#### 4.2.3 套餐详情列表
- 查看租户的所有套餐记录（包括已过期）
- 显示套餐状态（有效/已过期）

### 4.3 套餐管理模块
#### 4.3.1 到期提醒
- 套餐即将到期的提醒功能
- 支持邮件、站内信等提醒方式

#### 4.3.2 自动状态更新
- 定时任务检查套餐到期状态
- 自动更新过期套餐状态

#### 4.3.3 使用统计
- 套餐使用情况的统计报表
- 代理商分配统计
- 租户使用统计

## 5. 数据结构设计

### 5.1 核心设计理念：虚拟端口池

#### 5.1.1 设计思想
采用**虚拟端口池**架构，不存储具体的端口记录，而是通过算法实时计算端口可用性：
- **端口总数**：实时计算所有未过期套餐的端口数之和
- **已用端口**：统计当前分配给客服的小号数量
- **可用端口**：总端口数 - 已用端口数

#### 5.1.2 优势特点
- **存储效率高**：不需要为每个端口创建记录，节省90%以上存储空间
- **逻辑清晰**：通过简单算法实时计算，避免复杂的绑定关系
- **性能优秀**：查询效率高，计算复杂度低
- **扩展性强**：支持复杂业务规则，容易添加新功能

### 5.2 套餐分配记录表 (la_package_assignment)
```sql
CREATE TABLE `la_package_assignment` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `agent_id` int(11) NOT NULL COMMENT '代理商ID（分配者）',
  `tenant_id` int(11) NOT NULL COMMENT '租户ID（接受者）',
  `port_count` int(11) NOT NULL COMMENT '端口数量',
  `assign_time` int(10) NOT NULL COMMENT '分配时间',
  `expire_time` int(10) NOT NULL COMMENT '到期时间',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：1-有效，0-已过期',
  `remark` varchar(255) DEFAULT '' COMMENT '备注',
  `create_time` int(10) unsigned NOT NULL DEFAULT 0 COMMENT '创建时间',
  `update_time` int(10) unsigned NOT NULL DEFAULT 0 COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  KEY `idx_agent_id` (`agent_id`) USING BTREE,
  KEY `idx_tenant_id` (`tenant_id`) USING BTREE,
  KEY `idx_expire_time` (`expire_time`) USING BTREE,
  KEY `idx_status` (`status`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='套餐分配记录表';
```

### 5.3 小号分配记录表 (la_alt_account_assignment)
```sql
CREATE TABLE `la_alt_account_assignment` (
  `alt_account_id` int(11) NOT NULL COMMENT '小号ID',
  `tenant_id` int(11) NOT NULL COMMENT '租户ID',
  `operator_id` int(11) NOT NULL COMMENT '客服ID',
  `assign_time` int(10) NOT NULL COMMENT '分配时间',
  `priority` int(11) DEFAULT 0 COMMENT '优先级（同时间分配时使用）',
  `create_time` int(10) unsigned NOT NULL DEFAULT 0 COMMENT '创建时间',
  `update_time` int(10) unsigned NOT NULL DEFAULT 0 COMMENT '更新时间',
  PRIMARY KEY (`alt_account_id`) USING BTREE,
  KEY `idx_tenant_assign` (`tenant_id`, `assign_time`) USING BTREE,
  KEY `idx_operator_id` (`operator_id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='小号分配记录表';
```

### 5.4 关键字段说明
#### 5.4.1 套餐分配表字段
- **agent_id**: 分配套餐的代理商ID
- **tenant_id**: 接受套餐的租户ID
- **port_count**: 本次分配的端口数量
- **assign_time**: 套餐分配的时间
- **expire_time**: 套餐到期时间
- **status**: 套餐状态（1-有效，0-已过期）

#### 5.4.2 小号分配表字段
- **alt_account_id**: 小号ID（主键，一个小号只能分配一次）
- **tenant_id**: 租户ID（用于权限控制和查询优化）
- **operator_id**: 分配的客服ID
- **assign_time**: 分配时间（用于过期时的释放顺序）
- **priority**: 优先级（处理同时间分配的排序问题）

## 6. 接口设计

### 6.1 套餐分配接口
```
POST /adminapi/package/assign
请求参数：
{
  "tenant_id": 123,        // 租户ID
  "port_count": 100,       // 端口数量
  "expire_days": 30,       // 有效天数
  "remark": "测试分配"     // 备注（可选）
}

响应格式：
{
  "code": 1,
  "msg": "分配成功",
  "data": {
    "assignment_id": 456,
    "expire_time": "2025-09-25 10:30:00",
    "virtual_pool_status": {
      "total_ports": 150,
      "used_ports": 0,
      "available_ports": 150
    }
  }
}
```

### 6.2 租户套餐查询接口（虚拟端口池版本）
```
GET /adminapi/package/tenant-packages?tenant_id=123

响应格式：
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "port_pool_status": {
      "total_ports": 150,           // 虚拟端口池总端口数
      "used_ports": 120,            // 已使用端口数（已分配小号数）
      "available_ports": 30,        // 可用端口数
      "expiring_soon": 50           // 7天内即将过期的端口数
    },
    "packages": [
      {
        "id": 456,
        "port_count": 100,
        "assign_time": "2025-08-25 10:30:00",
        "expire_time": "2025-09-25 10:30:00",
        "status": 1,
        "agent_name": "代理商A"
      }
    ],
    "assigned_accounts": [
      {
        "alt_account_id": 789,
        "nickname": "小号1",
        "operator_name": "客服A",
        "assign_time": "2025-08-25 10:30:00",
        "priority": 0
      }
    ]
  }
}
```

### 6.3 小号分配端口接口（新增）
```
POST /adminapi/package/assign-alt-account
请求参数：
{
  "alt_account_ids": [101, 102, 103],  // 小号ID数组
  "operator_id": 456                   // 客服ID
}

响应格式：
{
  "code": 1,
  "msg": "分配成功",
  "data": {
    "assigned_count": 3,
    "port_pool_status": {
      "total_ports": 150,
      "used_ports": 123,
      "available_ports": 27
    },
    "assignments": [
      {
        "alt_account_id": 101,
        "priority": 0,
        "assign_time": "2025-08-25 10:30:00"
      }
    ]
  }
}
```

### 6.4 端口可用性检查接口（新增）
```
GET /adminapi/package/check-port-availability?tenant_id=123&need_count=5

响应格式：
{
  "code": 1,
  "msg": "检查完成",
  "data": {
    "available": true,              // 是否有足够端口
    "total_ports": 150,
    "used_ports": 145,
    "available_ports": 5,
    "need_ports": 5,
    "can_assign": true
  }
}
```

### 6.5 分配历史查询接口
```
GET /adminapi/package/assign-history

响应格式：
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "list": [
      {
        "id": 456,
        "tenant_id": 123,
        "tenant_name": "租户A",
        "port_count": 100,
        "assign_time": "2025-08-25 10:30:00",
        "expire_time": "2025-09-25 10:30:00",
        "status": 1
      }
    ],
    "total": 10,
    "page": 1,
    "limit": 20
  }
}
```

## 7. 技术实现

### 7.1 基于现有架构
- **控制器**: `app/adminapi/controller/PackageController.php`
- **业务逻辑**: `app/adminapi/logic/PackageLogic.php`
- **数据模型**: `app/common/model/Package.php`
- **验证器**: `app/adminapi/validate/PackageValidate.php`
- **列表类**: `app/adminapi/lists/PackageLists.php`

### 7.2 权限验证
- 复用现有的 `AgentAdminService` 验证代理商身份
- 利用现有的层级关系验证租户是否为代理商下级
- 集成现有的权限控制机制

### 7.3 虚拟端口池核心算法

#### 7.3.1 端口可用性实时计算
虚拟端口池通过以下算法实时计算端口状态：

**总端口数计算**：
- 查询租户所有未过期的套餐记录
- 将所有套餐的端口数相加
- 公式：总端口数 = Σ(未过期套餐.端口数)

**已用端口数计算**：
- 统计当前分配给客服的小号数量（基于package_id统计）
- 公式：已用端口数 = COUNT(package_id > 0 的小号)

**可用端口数计算**：
- 公式：可用端口数 = 总端口数 - 已用端口数

#### 7.3.2 分配时的端口检查
1. 实时计算当前可用端口数
2. 检查需要分配的小号数量是否超出可用端口
3. 如果端口足够，记录分配信息并更新小号状态
4. 如果端口不足，拒绝分配并提示错误信息

#### 7.3.3 过期处理机制
**自动检测**：
- 定时任务每分钟检查所有租户的端口状态
- 重新计算总端口数，检查是否出现已用端口 > 总端口的情况

**智能释放**：
- 当发现端口超出时，按以下优先级释放小号：
  1. 按分配时间排序（早分配的优先保留）
  2. 同时间分配的按优先级字段排序
  3. 优先级相同的按小号ID排序（确保结果稳定）
- 释放超出部分的小号分配，取消其客服绑定

#### 7.3.4 同时间分配处理
**优先级生成**：
- 同一秒内的分配，按顺序生成优先级编号（0, 1, 2...）
- 确保即使在高并发情况下也有明确的释放顺序

**稳定排序**：
- 多重排序条件确保结果稳定：分配时间 → 优先级 → 小号ID
- 避免因排序不稳定导致的释放结果不一致

## 8. 业务场景

### 8.1 典型分配场景
1. 代理商A需要为租户B分配100个端口，有效期30天
2. 系统验证代理商A有权限操作租户B
3. 记录分配信息，设置到期时间为30天后
4. 租户B的有效端口数增加100个

### 8.2 叠加分配场景
1. 租户B已有50个端口（9月1日到期）
2. 代理商A再次分配100个端口（9月15日到期）
3. 8月25日-9月1日期间：租户B有150个端口
4. 9月1日-9月15日期间：租户B有100个端口
5. 9月15日后：租户B有0个端口

### 8.3 虚拟端口池运行示例

#### 8.3.1 初始状态
- **8月20日**：租户获得50个端口（9月1日过期）
- **8月21日**：租户获得100个端口（9月15日过期）
- **当前状态**：总端口150个，已用0个，可用150个

#### 8.3.2 小号分配过程
**8月25日分配操作**：
1. 租户要分配150个小号给客服
2. 系统计算：总端口150个，已用0个，可用150个
3. 150 ≤ 150，允许分配
4. 创建150条分配记录，记录分配时间和优先级
5. 更新小号的客服分配状态
6. 分配后状态：总端口150个，已用150个，可用0个

#### 8.3.3 自动过期处理
**9月1日自动处理**：
1. 系统检测：50个端口过期，总端口变成100个
2. 发现问题：总端口100个，已用150个，超出50个
3. 智能释放：按分配时间排序，释放最早分配的50个小号
4. 处理结果：总端口100个，已用100个，恢复平衡
5. 通知租户：50个小号因端口过期被自动释放

**9月15日自动处理**：
1. 系统检测：剩余100个端口也过期，总端口变成0个
2. 全部释放：释放所有100个小号的客服分配
3. 最终状态：总端口0个，已用0个，所有小号恢复未分配状态

#### 8.3.4 同时间分配处理示例
**场景**：8月25日10:30:00，同时分配3个小号
1. 小号A：分配时间10:30:00，优先级0
2. 小号B：分配时间10:30:00，优先级1
3. 小号C：分配时间10:30:00，优先级2

**过期释放时**：如需释放1个小号，优先释放小号A（优先级最低）

## 9. 虚拟端口池技术优势

### 9.1 存储效率对比

#### 9.1.1 传统端口明细表方案
- **存储需求**：分配1000个端口需要创建1000条端口记录
- **数据增长**：端口数量 × 租户数量 = 海量数据
- **存储开销**：每个端口约100字节，1000端口需要100KB

#### 9.1.2 虚拟端口池方案
- **存储需求**：分配1000个端口只需要1条套餐记录
- **数据增长**：仅随套餐分配次数增长，与端口数量无关
- **存储开销**：每个套餐约100字节，节省99%存储空间

### 9.2 性能优势分析

#### 9.2.1 查询性能
- **端口可用性查询**：只需2个简单SQL查询
- **响应时间**：毫秒级响应，不受端口数量影响
- **并发支持**：支持高并发查询，无锁竞争

#### 9.2.2 计算复杂度
- **时间复杂度**：O(套餐数量) + O(分配数量)
- **空间复杂度**：O(1)，不需要额外存储空间
- **扩展性**：线性扩展，性能稳定

### 9.3 业务灵活性

#### 9.3.1 规则扩展
- **优先级策略**：可灵活调整释放优先级规则
- **时间策略**：支持复杂的时间段重叠处理
- **权限策略**：可添加更细粒度的权限控制

#### 9.3.2 功能扩展
- **端口预留**：可为重要客服预留端口
- **动态调整**：支持运行时调整端口分配策略
- **监控告警**：可添加端口使用率监控和告警

## 10. 后续扩展

### 10.1 可能的扩展功能
- 套餐模板管理（预设常用的端口数和时长组合）
- 套餐转移功能（租户间转移套餐）
- 套餐续费功能（延长到期时间）
- 套餐使用监控（端口使用率统计）
- 端口预留机制（为重要客服预留端口）
- 智能分配策略（根据客服等级自动分配）

### 10.2 性能优化
- 端口状态缓存机制（Redis缓存热点数据）
- 定时任务优化过期套餐处理
- 大数据量下的查询优化
- 分布式锁处理并发分配
- 异步处理端口过期通知

## 11. 注意事项

### 11.1 数据一致性
- 确保套餐分配的原子性操作
- 处理并发分配的数据一致性问题
- 使用数据库事务保证虚拟端口池计算的准确性
- 定时任务执行时的锁机制，避免重复处理

### 11.2 性能考虑
- 大量套餐记录的查询优化
- 实时计算有效端口数的性能优化
- 虚拟端口池计算结果的缓存策略
- 高并发场景下的查询性能保障

### 11.3 安全性
- 严格的权限验证
- 防止恶意分配大量套餐
- 操作日志记录
- 虚拟端口池计算结果的防篡改机制

### 11.4 虚拟端口池特殊注意事项

#### 11.4.1 计算准确性
- 确保端口总数和已用端口数的计算逻辑一致
- 处理套餐状态变更时的实时性问题
- 避免因时间差导致的计算误差

#### 11.4.2 并发处理
- 分配操作的原子性保证
- 多个租户同时操作时的隔离性
- 定时任务与实时操作的协调

#### 11.4.3 异常恢复
- 系统异常时的数据恢复机制
- 计算结果异常时的自动修复
- 端口状态不一致时的检测和修复

---

**文档状态**: 已整合虚拟端口池方案，技术方案完善
**技术特色**: 采用虚拟端口池架构，实现高效的端口资源管理
**下次讨论重点**: 具体代码实现、接口设计细化、测试方案制定
