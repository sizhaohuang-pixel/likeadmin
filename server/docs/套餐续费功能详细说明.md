# 套餐续费功能详细说明

## 📋 功能概述

套餐续费功能是套餐分配系统的重要组成部分，允许代理商为租户的套餐延长有效期，确保业务的连续性。该功能支持单个续费和批量续费两种模式，并提供了完善的权限控制和业务逻辑。

## 🎯 核心特性

### 1. 续费模式
- **单个续费**: 为指定套餐延长有效期
- **批量续费**: 同时为多个套餐续费，提高操作效率
- **智能计算**: 根据套餐当前状态智能计算新的到期时间

### 2. 时间计算逻辑
- **未过期套餐**: 在原到期时间基础上延长
  ```
  新到期时间 = 原到期时间 + 续费天数
  ```
- **已过期套餐**: 从当前时间开始计算
  ```
  新到期时间 = 当前时间 + 续费天数
  ```

### 3. 权限控制
- **代理商权限**: 只有代理商可以执行续费操作
- **所有权验证**: 只能续费自己分配的套餐
- **跨租户限制**: 不能续费其他代理商分配的套餐

## 🔧 技术实现

### 1. 数据库操作
```php
// 更新套餐信息
PackageAssignment::where('id', $packageId)->update([
    'expire_time' => $newExpireTime,
    'status' => 1, // 确保状态为有效
    'update_time' => time(),
    'remark' => ($package->remark ? $package->remark . ' | ' : '') . "续费{$extendDays}天"
]);
```

### 2. 事务保护
所有续费操作都在数据库事务中执行，确保数据一致性：
```php
Db::startTrans();
try {
    // 续费逻辑
    Db::commit();
    return true;
} catch (\Exception $e) {
    Db::rollback();
    self::setError($e->getMessage());
    return false;
}
```

### 3. 批量处理
批量续费采用循环处理方式，确保部分失败不影响其他套餐：
```php
foreach ($packageIds as $packageId) {
    $renewParams = [
        'package_id' => $packageId,
        'extend_days' => $extendDays
    ];
    
    if (self::renew($renewParams, $currentAdminId)) {
        $renewedCount++;
    }
}
```

## 📊 API接口详情

### 1. 单个套餐续费
**接口**: `POST /adminapi/package/renew`

**请求参数**:
```json
{
  "package_id": 123,       // 套餐ID，必填
  "extend_days": 30        // 续费天数，必填，1-3650天
}
```

**响应示例**:
```json
{
  "code": 1,
  "msg": "套餐续费成功",
  "data": [],
  "show": 1
}
```

### 2. 批量套餐续费
**接口**: `POST /adminapi/package/batch-renew`

**请求参数**:
```json
{
  "package_ids": [123, 124, 125],  // 套餐ID列表，最多100个
  "extend_days": 30                // 续费天数，必填
}
```

### 3. 获取可续费套餐列表
**接口**: `GET /adminapi/package/renewable-packages`

**请求参数**:
```
tenant_id=456  // 租户ID，必填
```

**响应数据**:
```json
{
  "code": 1,
  "data": [
    {
      "id": 123,
      "tenant_id": 456,
      "port_count": 100,
      "remaining_days": 5,
      "is_expired": false,
      "is_expiring_soon": true
    }
  ]
}
```

## ⚠️ 业务规则

### 1. 续费限制
- **天数范围**: 1-3650天
- **数量限制**: 批量续费最多100个套餐
- **权限验证**: 只能续费自己分配的套餐

### 2. 状态更新
- 续费成功后，套餐状态自动设为有效（status = 1）
- 备注信息会追加续费记录
- 更新时间会更新为当前时间

### 3. 错误处理
- 套餐不存在：返回"套餐记录不存在"
- 权限不足：返回"您没有权限为该套餐续费"
- 参数错误：返回具体的参数验证错误信息

## 🔍 使用场景

### 1. 即将过期提醒
系统会标识即将过期的套餐（7天内），代理商可以主动为租户续费：
```json
{
  "is_expiring_soon": true,
  "remaining_days": 3
}
```

### 2. 批量续费操作
对于有多个套餐的租户，可以使用批量续费功能：
```javascript
// 选择多个套餐进行批量续费
const selectedPackages = [123, 124, 125];
await batchRenew(selectedPackages, 30);
```

### 3. 过期套餐恢复
对于已过期的套餐，续费后会从当前时间开始计算新的有效期，立即恢复可用状态。

## 💡 最佳实践

### 1. 续费提醒
- 建议在套餐到期前7天提醒代理商
- 可以设置自动续费规则
- 提供批量续费功能提高效率

### 2. 续费策略
- 短期续费：1-30天，适用于临时需求
- 中期续费：30-90天，适用于常规业务
- 长期续费：90-365天，适用于稳定客户

### 3. 监控和统计
- 跟踪续费率和续费周期
- 分析客户续费行为
- 优化续费提醒策略

## 🚀 未来扩展

### 1. 自动续费
- 支持设置自动续费规则
- 基于余额的自动扣费
- 续费失败的通知机制

### 2. 续费优惠
- 长期续费折扣
- 批量续费优惠
- VIP客户专享价格

### 3. 数据分析
- 续费趋势分析
- 客户生命周期管理
- 收入预测和规划

---

## 📞 技术支持

如有问题，请检查：
1. 套餐ID是否存在且有权限
2. 续费天数是否在合理范围内
3. 代理商权限是否正确配置
4. 数据库事务是否正常执行

续费功能为套餐分配系统提供了完整的生命周期管理能力，确保业务的连续性和稳定性！
