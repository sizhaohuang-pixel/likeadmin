# 套餐分配系统权限控制说明

## 概述

套餐分配系统实现了严格的三级权限控制，确保：
1. **代理商只能为自己的下级租户分配套餐**
2. **租户只能为自己的下级客服分配小号**

## 权限层级结构

```
Root管理员 (root=1)
    ├── 代理商 (parent_id=null, root=0)
    │   ├── 租户1 (parent_id=代理商ID)
    │   │   ├── 客服1 (parent_id=租户1ID)
    │   │   └── 客服2 (parent_id=租户1ID)
    │   └── 租户2 (parent_id=代理商ID)
    │       └── 客服3 (parent_id=租户2ID)
    └── 代理商2
        └── 租户3
            └── 客服4
```

## 权限控制实现

### 1. 套餐分配权限控制

**方法**: `PackageLogic::validateAgentPermission()`

**验证规则**:
- 代理商必须存在且未被禁用
- 租户必须存在且未被禁用
- 租户的`parent_id`必须等于代理商ID（Root用户除外）

**代码实现**:
```php
// 检查层级关系：租户必须是代理商的下级（root用户除外）
if ($agent->root != 1 && $tenant->parent_id != $agentId) {
    return '您只能为自己的下级租户分配套餐';
}
```

### 2. 小号分配权限控制

**方法**: `PackageLogic::validateOperatorPermission()`

**验证规则**:
- 租户必须存在且未被禁用
- 客服必须存在且未被禁用
- 客服的`parent_id`必须等于租户ID

**代码实现**:
```php
// 检查层级关系：客服必须是租户的下级
if ($operator->parent_id != $tenantId) {
    return '您只能为自己的下级客服分配小号';
}
```

### 3. 查询权限控制

**方法**: `PackageLogic::validateTenantAccess()`

**验证规则**:
- Root用户可以查看所有租户
- 代理商只能查看自己的下级租户
- 租户只能查看自己的信息

## API接口权限验证

### 套餐分配相关接口

| 接口 | 权限验证 | 说明 |
|------|----------|------|
| `POST /package/assign` | `validateAgentPermission` | 代理商分配套餐给下级租户 |
| `GET /package/tenant-packages` | `validateTenantAccess` | 查看租户套餐信息 |
| `GET /package/tenant-options` | 层级过滤 | 只显示下级租户选项 |

### 小号分配相关接口

| 接口 | 权限验证 | 说明 |
|------|----------|------|
| `POST /package/assign-alt-account` | `validateOperatorPermission` | 租户分配小号给下级客服 |
| `GET /package/operator-options` | 层级过滤 | 只显示下级客服选项 |

## 控制器层权限实现

### 租户选项接口
```php
public function tenantOptions()
{
    $currentAdmin = \app\common\model\auth\Admin::findOrEmpty($this->adminId);
    $query = \app\common\model\auth\Admin::field('id,name,account');
    
    // 权限过滤：非root用户只能看到自己的下级租户
    if ($currentAdmin->root != 1) {
        $query->where('parent_id', $this->adminId);
    }
    
    return $this->data($query->where('disable', 0)->select()->toArray());
}
```

### 客服选项接口
```php
public function operatorOptions()
{
    // 获取当前租户的下级客服（运营）
    $operators = \app\common\model\auth\Admin::field('id,name,account')
        ->where('disable', 0)
        ->where('parent_id', $this->adminId) // 客服的上级是当前租户
        ->select()->toArray();
    
    return $this->data($operators);
}
```

## 权限验证流程

### 套餐分配流程
1. 验证代理商身份和状态
2. 验证租户存在和状态
3. 验证层级关系（租户是否为代理商下级）
4. 执行套餐分配操作

### 小号分配流程
1. 验证租户身份和状态
2. 验证客服存在和状态
3. 验证层级关系（客服是否为租户下级）
4. 检查端口可用性
5. 执行小号分配操作

## 错误提示信息

| 错误场景 | 提示信息 |
|----------|----------|
| 代理商不存在 | "代理商不存在" |
| 代理商被禁用 | "代理商已被禁用" |
| 租户不存在 | "租户不存在" |
| 租户被禁用 | "租户已被禁用" |
| 客服不存在 | "客服不存在" |
| 客服被禁用 | "客服已被禁用" |
| 套餐分配权限不足 | "您只能为自己的下级租户分配套餐" |
| 小号分配权限不足 | "您只能为自己的下级客服分配小号" |
| 查看权限不足 | "您没有权限查看该租户信息" |

## 安全特性

1. **严格的层级验证**: 确保操作只能在直接的上下级关系中进行
2. **状态检查**: 验证所有相关用户的启用状态
3. **权限隔离**: 不同角色只能访问自己权限范围内的数据
4. **Root特权**: Root用户拥有最高权限，可以操作所有数据
5. **防止越权**: 通过parent_id字段严格控制访问边界

## 测试验证

系统已通过完整的权限控制测试：
- ✅ 代理商可以为下级租户分配套餐
- ✅ 租户可以为下级客服分配小号
- ✅ 正确拒绝无效的跨级操作
- ✅ 层级关系验证正确
- ✅ 状态检查有效

权限控制系统确保了数据安全和操作合规性。
