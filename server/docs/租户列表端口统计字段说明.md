# 租户列表端口统计字段说明

## 概述

为租户列表增加了四个端口统计字段，帮助管理员实时了解每个租户的端口使用情况。

## 新增字段

### 1. total_ports - 端口总数
- **含义**: 当前有效端口数量
- **计算逻辑**: 所有未过期且状态为有效的套餐端口数之和
- **SQL查询**:
  ```sql
  SELECT SUM(port_count) 
  FROM la_package_assignment 
  WHERE tenant_id = ? AND status = 1 AND expire_time > UNIX_TIMESTAMP()
  ```

### 2. used_ports - 已用端口
- **含义**: 已分配给客服的小号数量
- **计算逻辑**: 该租户下已分配的小号总数（基于package_id统计）
- **SQL查询**:
  ```sql
  SELECT COUNT(*)
  FROM la_alt_account
  WHERE tenant_id = ? AND package_id > 0
  ```

### 3. available_ports - 空闲端口
- **含义**: 可用于分配的端口数量
- **计算逻辑**: 端口总数 - 已用端口数（最小值为0）
- **公式**: `max(0, total_ports - used_ports)`

### 4. expired_ports - 过期端口
- **含义**: 已过期但状态仍为有效的套餐端口数
- **计算逻辑**: 过期时间小于等于当前时间但状态仍为1的套餐端口数之和
- **SQL查询**:
  ```sql
  SELECT SUM(port_count) 
  FROM la_package_assignment 
  WHERE tenant_id = ? AND status = 1 AND expire_time <= UNIX_TIMESTAMP()
  ```

## 实现位置

### 文件路径
- **列表类**: `app/adminapi/lists/auth/TenantLists.php`
- **控制器**: `app/adminapi/controller/auth/TenantController.php`

### 核心方法
```php
/**
 * 计算租户端口统计信息
 */
private function calculatePortStats(int $tenantId): array
{
    $currentTime = time();
    
    // 1. 计算端口总数（当前有效端口数量）
    $totalPorts = PackageAssignment::where('tenant_id', $tenantId)
        ->where('status', 1)
        ->where('expire_time', '>', $currentTime)
        ->sum('port_count') ?: 0;
    
    // 2. 计算已用端口数（使用新机制：基于package_id统计）
    $usedPorts = PortStatisticsService::getTenantUsedPorts($tenantId);
    
    // 3. 计算空闲端口数
    $availablePorts = max(0, $totalPorts - $usedPorts);
    
    // 4. 计算过期端口数
    $expiredPorts = PackageAssignment::where('tenant_id', $tenantId)
        ->where('status', 1)
        ->where('expire_time', '<=', $currentTime)
        ->sum('port_count') ?: 0;
    
    return [
        'total_ports' => (int)$totalPorts,
        'used_ports' => (int)$usedPorts,
        'available_ports' => (int)$availablePorts,
        'expired_ports' => (int)$expiredPorts,
    ];
}
```

## API响应示例

### 租户列表接口
**请求**: `GET /adminapi/auth.tenant/lists`

**响应示例**:
```json
{
    "code": 1,
    "msg": "成功",
    "data": {
        "lists": [
            {
                "id": 45,
                "name": "租户1",
                "account": "zuhu1",
                "total_ports": 200,
                "used_ports": 0,
                "available_ports": 200,
                "expired_ports": 0,
                "create_time": "2024-08-27 10:00:00",
                "disable": 0,
                "role_name": "租户",
                "parent_name": "代理商1"
            }
        ],
        "count": 1,
        "page": 1,
        "limit": 15
    }
}
```

## 导出功能

端口统计字段已添加到Excel导出配置中：

```php
public function setExcelFields(): array
{
    return [
        'account' => '账号',
        'name' => '名称',
        'role_name' => '角色',
        'total_ports' => '端口总数',      // 新增
        'used_ports' => '已用端口',       // 新增
        'available_ports' => '空闲端口',  // 新增
        'expired_ports' => '过期端口',    // 新增
        'create_time' => '创建时间',
        'login_time' => '最近登录时间',
        'disable_desc' => '状态',
        'parent_name' => '上级',
    ];
}
```

## 性能考虑

### 查询优化
1. **索引使用**: 利用现有的复合索引进行高效查询
2. **批量计算**: 在列表循环中为每个租户单独计算，避免N+1查询
3. **类型转换**: 确保返回整数类型，避免浮点数问题

### 缓存策略（可选）
对于大量租户的情况，可以考虑：
1. 添加Redis缓存，缓存时间5-10分钟
2. 在套餐分配/小号分配时清除相关缓存
3. 提供手动刷新缓存的接口

## 业务价值

### 管理员视角
1. **资源监控**: 实时了解每个租户的端口使用情况
2. **容量规划**: 根据使用率决定是否需要分配更多端口
3. **异常发现**: 快速识别过期端口和资源浪费

### 运营价值
1. **数据驱动**: 基于真实使用数据进行决策
2. **成本控制**: 避免过度分配或资源不足
3. **客户服务**: 主动发现并解决客户端口不足问题

## 测试验证

✅ **端口统计计算正确性**: 与现有模型方法计算结果一致
✅ **数据类型正确**: 所有字段返回整数类型
✅ **导出功能**: 端口统计字段已正确添加到导出配置
✅ **性能表现**: 查询效率良好，无明显性能问题

## 使用说明

1. **查看租户列表**: 访问租户管理页面即可看到端口统计信息
2. **导出数据**: 使用导出功能可以获得包含端口统计的Excel文件
3. **监控告警**: 可基于这些字段设置监控规则（如空闲端口过低告警）

端口统计功能为租户管理提供了重要的数据支持，有助于提升资源管理效率和用户体验。
