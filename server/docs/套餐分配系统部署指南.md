# 代理商套餐分配系统部署指南

## 📋 系统概述

### **功能特性**
- ✅ **虚拟端口池架构**: 高效的端口管理，无需存储具体端口记录
- ✅ **智能释放算法**: 过期时按优先级自动释放超出端口
- ✅ **多层权限控制**: 代理商、租户、管理员三级权限体系
- ✅ **实时状态计算**: 毫秒级响应的端口可用性查询
- ✅ **完整API接口**: 14个接口覆盖所有业务场景

### **技术架构**
- **框架**: ThinkPHP 8.0
- **PHP版本**: >=8.0
- **数据库**: MySQL 5.7+
- **架构模式**: MVC分层架构 + 多应用模式
- **权限机制**: RBAC角色权限控制

## 🚀 部署步骤

### **1. 数据库配置**

#### 创建数据表
```bash
# 进入MySQL命令行
mysql -u root -p

# 选择数据库
use your_database_name;

# 执行数据表创建脚本
source database/package_assignment_tables.sql;

# 执行权限配置脚本
source database/package_permissions.sql;
```

#### 验证表创建
```sql
-- 检查表是否创建成功
SHOW TABLES LIKE 'la_package%';

-- 检查表结构
DESC la_package_assignment;
DESC la_alt_account_assignment;

-- 检查权限菜单
SELECT id, name, perms FROM la_system_menu WHERE perms LIKE 'package%';
```

### **2. 代码部署**

#### 文件结构确认
```
app/
├── adminapi/
│   ├── controller/
│   │   └── PackageController.php          # 控制器
│   ├── logic/
│   │   └── PackageLogic.php               # 业务逻辑
│   ├── validate/
│   │   └── PackageValidate.php            # 验证器
│   └── lists/
│       └── PackageLists.php               # 列表类
├── common/
│   └── model/
│       └── package/
│           ├── PackageAssignment.php      # 套餐分配模型
│           └── AltAccountAssignment.php   # 小号分配模型
database/
├── package_assignment_tables.sql         # 数据表脚本
└── package_permissions.sql               # 权限配置脚本
docs/
├── 套餐分配系统API接口文档.md
├── 套餐分配系统权限清单.md
├── 套餐分配系统路由配置.md
└── 套餐分配系统部署指南.md
```

#### 权限验证
```bash
# 检查文件权限
ls -la app/adminapi/controller/PackageController.php
ls -la app/common/model/package/

# 确保Web服务器有读取权限
chmod 644 app/adminapi/controller/PackageController.php
chmod 644 app/common/model/package/*.php
```

### **3. 权限配置**

#### 角色权限分配
```sql
-- 为代理商角色分配权限（假设代理商角色ID为3）
INSERT INTO la_system_role_menu (role_id, menu_id) 
SELECT 3, id FROM la_system_menu WHERE perms IN (
    'package/assign',
    'package/tenant-packages', 
    'package/assign-history',
    'package/lists',
    'package/statistics',
    'package/detail',
    'package/tenant-options'
);

-- 为租户角色分配权限（假设租户角色ID为2）
INSERT INTO la_system_role_menu (role_id, menu_id) 
SELECT 2, id FROM la_system_menu WHERE perms IN (
    'package/tenant-packages',
    'package/assign-alt-account',
    'package/check-port-availability',
    'package/port-pool-status',
    'package/operator-options',
    'package/alt-account-options'
);

-- 为管理员角色分配所有权限（假设管理员角色ID为1）
INSERT INTO la_system_role_menu (role_id, menu_id) 
SELECT 1, id FROM la_system_menu WHERE perms LIKE 'package%';
```

#### 验证权限配置
```sql
-- 查看权限分配情况
SELECT 
    r.name as role_name, 
    m.name as menu_name, 
    m.perms 
FROM la_system_role r
JOIN la_system_role_menu rm ON r.id = rm.role_id
JOIN la_system_menu m ON rm.menu_id = m.id
WHERE m.perms LIKE 'package%'
ORDER BY r.id, m.sort DESC;
```

### **4. 缓存清理**

```bash
# 清理应用缓存
php think clear

# 清理路由缓存
php think route:clear

# 清理配置缓存
php think config:clear
```

## 🧪 功能测试

### **1. API接口测试**

#### 基础连通性测试
```bash
# 测试登录接口
curl -X POST "http://your-domain/adminapi/login/account" \
  -H "Content-Type: application/json" \
  -d '{
    "account": "admin",
    "password": "123456"
  }'

# 获取token后测试套餐列表接口
curl -X GET "http://your-domain/adminapi/package/lists" \
  -H "Authorization: Bearer your-token-here"
```

#### 核心功能测试
```bash
# 1. 测试套餐分配
curl -X POST "http://your-domain/adminapi/package/assign" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "tenant_id": 123,
    "port_count": 100,
    "expire_days": 30,
    "remark": "测试分配"
  }'

# 2. 测试租户套餐查询
curl -X GET "http://your-domain/adminapi/package/tenant-packages?tenant_id=123" \
  -H "Authorization: Bearer your-token"

# 3. 测试端口可用性检查
curl -X GET "http://your-domain/adminapi/package/check-port-availability?tenant_id=123&need_count=50" \
  -H "Authorization: Bearer your-token"
```

### **2. 权限测试**

#### 代理商权限测试
```bash
# 使用代理商账号登录
# 测试是否可以分配套餐
# 测试是否只能查看下级租户数据
```

#### 租户权限测试
```bash
# 使用租户账号登录
# 测试是否可以分配小号
# 测试是否只能查看自己的数据
```

### **3. 数据库测试**

#### 虚拟端口池算法测试
```sql
-- 创建测试数据
INSERT INTO la_package_assignment (agent_id, tenant_id, port_count, assign_time, expire_time, status, create_time, update_time) VALUES
(1, 2, 100, UNIX_TIMESTAMP(), UNIX_TIMESTAMP() + 2592000, 1, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
(1, 2, 200, UNIX_TIMESTAMP(), UNIX_TIMESTAMP() + 2592000, 1, UNIX_TIMESTAMP(), UNIX_TIMESTAMP());

INSERT INTO la_alt_account_assignment (alt_account_id, tenant_id, operator_id, assign_time, priority, create_time, update_time) VALUES
(1001, 2, 3, UNIX_TIMESTAMP(), 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP()),
(1002, 2, 3, UNIX_TIMESTAMP(), 1, UNIX_TIMESTAMP(), UNIX_TIMESTAMP());

-- 测试端口计算
-- 总端口数应该是300（100+200）
SELECT SUM(port_count) as total_ports FROM la_package_assignment WHERE tenant_id = 2 AND status = 1 AND expire_time > UNIX_TIMESTAMP();

-- 已用端口数应该是2
SELECT COUNT(*) as used_ports FROM la_alt_account_assignment WHERE tenant_id = 2;

-- 可用端口数应该是298（300-2）
```

## 🔧 配置优化

### **1. 数据库优化**

#### 索引优化
```sql
-- 检查索引使用情况
EXPLAIN SELECT SUM(port_count) FROM la_package_assignment 
WHERE tenant_id = 123 AND status = 1 AND expire_time > UNIX_TIMESTAMP();

EXPLAIN SELECT COUNT(*) FROM la_alt_account_assignment WHERE tenant_id = 123;

-- 如果查询慢，可以添加额外索引
-- ALTER TABLE la_package_assignment ADD INDEX idx_tenant_status_expire_time (tenant_id, status, expire_time);
```

#### 性能监控
```sql
-- 监控慢查询
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 查看表状态
SHOW TABLE STATUS LIKE 'la_package%';
```

### **2. 应用优化**

#### 缓存配置
```php
// config/cache.php
return [
    'default' => 'redis',
    'stores' => [
        'redis' => [
            'type' => 'redis',
            'host' => '127.0.0.1',
            'port' => 6379,
            'password' => '',
            'select' => 0,
            'timeout' => 0,
            'expire' => 0,
            'persistent' => false,
            'prefix' => 'likeadmin:',
        ],
    ],
];
```

#### 日志配置
```php
// config/log.php - 添加套餐相关日志
'channels' => [
    'package' => [
        'type' => 'File',
        'path' => runtime_path() . 'log/package/',
        'level' => 'info',
        'file_size' => 2097152,
        'max_files' => 30,
    ],
],
```

## 📊 监控和维护

### **1. 定时任务配置**

#### 过期套餐处理
```bash
# 添加到crontab
# 每小时执行一次过期处理
0 * * * * curl -X POST "http://your-domain/adminapi/package/handle-expired" -H "Authorization: Bearer system-token"

# 或者使用ThinkPHP命令行
0 * * * * cd /path/to/project && php think package:handle-expired
```

#### 数据统计任务
```bash
# 每天凌晨生成统计报告
0 0 * * * curl -X GET "http://your-domain/adminapi/package/statistics" -H "Authorization: Bearer system-token"
```

### **2. 日志监控**

#### 关键指标监控
- 套餐分配成功率
- 端口使用率
- 过期处理效率
- API响应时间

#### 异常监控
- 权限验证失败
- 端口不足错误
- 数据库连接异常
- 业务逻辑错误

### **3. 备份策略**

#### 数据备份
```bash
# 每日备份套餐相关数据
mysqldump -u root -p your_database la_package_assignment la_alt_account_assignment > package_backup_$(date +%Y%m%d).sql

# 保留30天备份
find /backup/path -name "package_backup_*.sql" -mtime +30 -delete
```

## ⚠️ 注意事项

### **1. 安全考虑**
- 确保数据库连接使用强密码
- 定期更新系统和依赖包
- 监控异常访问和操作
- 备份重要数据

### **2. 性能考虑**
- 合理设置缓存策略
- 监控数据库查询性能
- 控制API请求频率
- 定期清理过期数据

### **3. 扩展性考虑**
- 预留足够的数据库容量
- 考虑分库分表方案
- 设计合理的缓存策略
- 保持代码的可维护性

## 📞 技术支持

如遇到部署问题，请检查：
1. PHP版本是否>=8.0
2. 数据库表是否正确创建
3. 权限配置是否正确
4. 文件权限是否正确
5. 缓存是否已清理

详细的API文档请参考：`docs/套餐分配系统API接口文档.md`
