# 小号分配逻辑详解

## 概述

小号分配是指将租户的小号账户分配给具体的客服人员使用的过程。这个过程集成了套餐分配系统，实现了严格的端口配额控制和权限验证。

## 🔄 完整分配流程

### 调用入口
```php
// API接口调用
AltAccountLogic::assignCustomerService($params, $currentAdminId);

// 参数结构
$params = [
    'alt_account_ids' => [1, 2, 3],  // 要分配的小号ID数组
    'operator_id' => 56              // 目标客服ID
];
$currentAdminId = 45;  // 当前操作的租户ID
```

### 核心流程（5个步骤）

## 📋 第一步：权限层级验证

### 目的
确保当前租户只能将小号分配给自己的直接下级客服，防止越权操作。

### 实现逻辑
```php
// 检查客服是否为当前租户的下级
if (!AdminHierarchyService::hasPermission($currentAdminId, $operatorId)) {
    throw new \Exception('您没有权限将小号分配给该运营人员');
}
```

### 验证规则
- **层级关系**: 客服的`parent_id`必须等于当前租户的ID
- **权限边界**: 租户只能管理自己的直接下级
- **安全保障**: 防止跨租户分配小号

### 数据表依赖
```sql
-- 检查层级关系
SELECT * FROM la_admin 
WHERE id = {operatorId} AND parent_id = {currentAdminId}
```

## 🎭 第二步：角色权限验证

### 目的
确保分配目标具有正确的运营角色，避免将小号分配给非客服人员。

### 实现逻辑
```php
// 验证运营是否具有运营角色
$hasOperatorRole = AdminRole::where('admin_id', $operatorId)
    ->where('role_id', OperatorLogic::$operatorRoleId)
    ->find();
if (!$hasOperatorRole) {
    throw new \Exception('选择的人员不是运营角色');
}
```

### 验证规则
- **角色匹配**: 目标用户必须具有运营角色
- **角色有效**: 角色分配记录必须存在且有效
- **业务逻辑**: 只有运营人员才能接受小号分配

### 数据表依赖
```sql
-- 检查角色分配
SELECT * FROM la_admin_role 
WHERE admin_id = {operatorId} AND role_id = {operatorRoleId}
```

## 🔢 第三步：端口可用性检查（核心）

### 目的
基于套餐分配系统检查租户是否有足够的端口配额进行分配。

### 实现逻辑
```php
// 检查端口可用性
$needCount = count($altAccountIds);
$availability = self::checkPortAvailability($currentAdminId, $needCount);
if (!$availability['available']) {
    throw new \Exception('端口不足，当前可用端口：' . $availability['available_ports'] . '个，需要：' . $needCount . '个');
}
```

### 端口计算详解

#### 3.1 计算总端口数
```php
// 从套餐分配表统计有效端口
$totalPorts = PackageAssignment::where('tenant_id', $tenantId)
    ->where('status', 1)           // 状态有效
    ->where('expire_time', '>', time())  // 未过期
    ->sum('port_count') ?: 0;
```

**说明**:
- **数据来源**: `la_package_assignment` 表
- **筛选条件**: 状态为1且未过期的套餐
- **计算方式**: 所有有效套餐的端口数之和

#### 3.2 计算已用端口数
```php
// 从小号表统计已分配的小号数量（使用新机制）
$usedPorts = AltAccount::where('tenant_id', $tenantId)
    ->where('package_id', '>', 0)  // 基于package_id统计
    ->count();
```

**说明**:
- **数据来源**: `la_alt_account` 表
- **筛选条件**: `package_id > 0` 表示已分配并记录了使用的套餐
- **计算方式**: 统计符合条件的小号数量
- **优势**: 精确追踪每个小号使用的具体套餐

#### 3.3 计算可用端口数
```php
// 可用端口 = 总端口 - 已用端口
$availablePorts = max(0, $totalPorts - $usedPorts);
```

#### 3.4 可用性判断
```php
return [
    'available' => $availablePorts >= $needCount,  // 是否可分配
    'total_ports' => (int)$totalPorts,           // 总端口数
    'used_ports' => (int)$usedPorts,             // 已用端口数
    'available_ports' => (int)$availablePorts,   // 可用端口数
    'need_ports' => $needCount,                  // 需要端口数
];
```

## 📱 第四步：小号状态验证

### 目的
确保要分配的小号都是有效的、属于当前租户的、且未被分配的。

### 实现逻辑
```php
foreach ($altAccountIds as $altAccountId) {
    $altAccount = AltAccount::findOrEmpty($altAccountId);
    
    // 4.1 小号存在性检查
    if ($altAccount->isEmpty()) {
        throw new \Exception("小号ID {$altAccountId} 不存在");
    }
    
    // 4.2 所有权检查
    if ($altAccount->tenant_id != $currentAdminId) {
        throw new \Exception("您没有权限操作小号ID {$altAccountId}");
    }
    
    // 4.3 分配状态检查
    if ($altAccount->operator_id > 0) {
        throw new \Exception("小号ID {$altAccountId} 已被分配给其他客服");
    }
}
```

### 验证规则
- **存在性**: 小号记录必须存在
- **所有权**: 小号必须属于当前租户
- **可用性**: 小号必须未被分配（`operator_id = 0`）

## ✅ 第五步：执行分配操作

### 目的
在所有验证通过后，执行实际的分配操作。

### 实现逻辑
```php
// 批量更新小号的运营分配
AltAccount::where('id', 'in', $altAccountIds)->update([
    'operator_id' => $operatorId,  // 设置客服ID
    'update_time' => time()        // 记录分配时间
]);
```

### 操作特点
- **批量更新**: 一次SQL操作更新多个小号
- **时间记录**: `update_time`记录分配时间
- **原子操作**: 在数据库事务中执行

## 🛡️ 事务安全保障

### 事务结构
```php
Db::startTrans();  // 开始事务
try {
    // 执行所有验证和分配操作
    Db::commit();   // 提交事务
    return true;
} catch (\Exception $e) {
    Db::rollback(); // 回滚事务
    self::setError($e->getMessage());
    return false;
}
```

### 安全特性
- **原子性**: 要么全部成功，要么全部失败
- **一致性**: 数据状态始终保持一致
- **隔离性**: 并发操作不会相互干扰
- **持久性**: 成功的操作永久保存

## 📊 数据流向图

```
输入参数
    ↓
权限层级验证 → AdminHierarchyService
    ↓
角色权限验证 → la_admin_role 表
    ↓
端口可用性检查 → la_package_assignment + la_alt_account
    ↓
小号状态验证 → la_alt_account 表
    ↓
执行分配操作 → 更新 la_alt_account.operator_id
    ↓
返回结果
```

## 🎯 业务价值

### 1. 资源管控
- **端口配额**: 严格控制分配数量，防止超出套餐限制
- **成本控制**: 避免资源浪费和超额使用
- **容量规划**: 基于实际使用情况进行资源规划

### 2. 权限安全
- **层级控制**: 确保权限边界，防止越权操作
- **角色验证**: 确保分配目标的合法性
- **数据安全**: 保护租户数据不被非法访问

### 3. 业务流程
- **规范操作**: 标准化的分配流程
- **状态管理**: 清晰的小号状态跟踪
- **历史记录**: 完整的操作时间记录

## 🔍 常见问题

### Q1: 为什么要检查端口可用性？
**A**: 因为每个租户的端口数量是有限的（基于购买的套餐），需要确保不超出配额。

### Q2: 小号分配后如何释放？
**A**: 将`operator_id`设置为0即可释放，释放时按ID顺序（先分配的先释放）。

### Q3: 如何查看租户的端口使用情况？
**A**: 在租户列表中可以看到实时的端口统计信息。

### Q4: 分配失败如何处理？
**A**: 系统会回滚所有操作，返回具体的错误信息，不会产生数据不一致。

这套小号分配逻辑既保证了业务需求的实现，又确保了系统的安全性和数据的一致性。
