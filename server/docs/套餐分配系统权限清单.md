# 代理商套餐分配系统权限清单

## 📋 权限标识符列表

### 🔥 核心功能权限

| 权限标识符 | 功能描述 | 请求方式 | 接口路径 | 适用角色 |
|-----------|---------|---------|---------|---------|
| `package/assign` | 分配套餐 | POST | `/adminapi/package/assign` | 代理商 |
| `package/tenant-packages` | 查看租户套餐 | GET | `/adminapi/package/tenant-packages` | 代理商、租户 |
| `package/assign-alt-account` | 分配小号 | POST | `/adminapi/package/assign-alt-account` | 租户 |
| `package/check-port-availability` | 检查端口可用性 | GET | `/adminapi/package/check-port-availability` | 租户 |
| `package/assign-history` | 查看分配历史 | GET | `/adminapi/package/assign-history` | 代理商、管理员 |

### 📊 管理功能权限

| 权限标识符 | 功能描述 | 请求方式 | 接口路径 | 适用角色 |
|-----------|---------|---------|---------|---------|
| `package/lists` | 套餐列表查询 | GET | `/adminapi/package/lists` | 代理商、管理员 |
| `package/statistics` | 统计信息 | GET | `/adminapi/package/statistics` | 代理商、管理员 |
| `package/detail` | 套餐详情 | GET | `/adminapi/package/detail` | 代理商、管理员 |
| `package/port-pool-status` | 端口池状态 | GET | `/adminapi/package/port-pool-status` | 租户、代理商 |

### ⚙️ 系统维护权限

| 权限标识符 | 功能描述 | 请求方式 | 接口路径 | 适用角色 |
|-----------|---------|---------|---------|---------|
| `package/handle-expired` | 处理过期套餐 | POST | `/adminapi/package/handle-expired` | 管理员 |
| `package/update-expired-status` | 更新过期状态 | POST | `/adminapi/package/update-expired-status` | 管理员 |

### 🔧 辅助功能权限

| 权限标识符 | 功能描述 | 请求方式 | 接口路径 | 适用角色 |
|-----------|---------|---------|---------|---------|
| `package/tenant-options` | 租户选项列表 | GET | `/adminapi/package/tenant-options` | 代理商 |
| `package/operator-options` | 客服选项列表 | GET | `/adminapi/package/operator-options` | 租户 |
| `package/alt-account-options` | 小号选项列表 | GET | `/adminapi/package/alt-account-options` | 租户 |

## 🎯 角色权限分配方案

### 1. **代理商角色** (建议role_id = 3)

**核心权限**：
- ✅ `package/assign` - 为下级租户分配套餐
- ✅ `package/tenant-packages` - 查看下级租户套餐状态
- ✅ `package/assign-history` - 查看自己的分配历史
- ✅ `package/lists` - 查看套餐分配列表
- ✅ `package/statistics` - 查看统计信息
- ✅ `package/detail` - 查看套餐详情
- ✅ `package/tenant-options` - 获取下级租户列表

**业务场景**：
- 代理商登录后可以为自己的下级租户分配端口套餐
- 可以查看所有分配记录和统计信息
- 可以监控租户的端口使用情况

### 2. **租户角色** (建议role_id = 2)

**核心权限**：
- ✅ `package/tenant-packages` - 查看自己的套餐信息
- ✅ `package/assign-alt-account` - 分配小号给客服
- ✅ `package/check-port-availability` - 检查端口可用性
- ✅ `package/port-pool-status` - 查看端口池状态
- ✅ `package/operator-options` - 获取客服列表
- ✅ `package/alt-account-options` - 获取可分配小号列表

**业务场景**：
- 租户登录后可以查看自己的端口套餐状态
- 可以将端口分配给具体的客服使用
- 可以实时监控端口使用情况

### 3. **平台管理员角色** (建议role_id = 1)

**全部权限**：
- ✅ 所有套餐管理权限
- ✅ `package/handle-expired` - 处理过期套餐
- ✅ `package/update-expired-status` - 更新过期状态
- ✅ 系统维护和监控权限

**业务场景**：
- 平台管理员可以查看所有数据
- 负责系统维护和过期处理
- 可以进行全局统计和监控

## 🛡️ 权限验证机制

### 1. **中间件验证**
- 基于 `AuthMiddleware` 进行权限验证
- 自动检查用户是否具有对应的权限标识符
- root用户（root=1）自动跳过权限验证

### 2. **业务层验证**
- 在Logic层进行二次权限验证
- 检查层级关系（代理商只能操作下级租户）
- 验证数据归属权（租户只能操作自己的数据）

### 3. **数据过滤**
- 根据用户身份自动过滤可见数据
- 代理商只能看到下级租户的数据
- 租户只能看到自己的数据

## 📝 权限配置步骤

### 1. **执行SQL脚本**
```sql
-- 执行权限配置脚本
source database/package_permissions.sql;
```

### 2. **分配角色权限**
```sql
-- 为代理商角色分配权限（假设代理商角色ID为3）
INSERT INTO la_system_role_menu (role_id, menu_id) 
SELECT 3, id FROM la_system_menu WHERE perms IN (
    'package/assign',
    'package/tenant-packages', 
    'package/assign-history',
    'package/lists',
    'package/statistics',
    'package/detail',
    'package/tenant-options'
);

-- 为租户角色分配权限（假设租户角色ID为2）
INSERT INTO la_system_role_menu (role_id, menu_id) 
SELECT 2, id FROM la_system_menu WHERE perms IN (
    'package/tenant-packages',
    'package/assign-alt-account',
    'package/check-port-availability',
    'package/port-pool-status',
    'package/operator-options',
    'package/alt-account-options'
);
```

### 3. **验证权限配置**
```sql
-- 查看角色权限分配情况
SELECT r.name as role_name, m.name as menu_name, m.perms 
FROM la_system_role r
JOIN la_system_role_menu rm ON r.id = rm.role_id
JOIN la_system_menu m ON rm.menu_id = m.id
WHERE m.perms LIKE 'package%'
ORDER BY r.id, m.sort DESC;
```

## ⚠️ 注意事项

### 1. **角色ID确认**
- 执行前请确认实际系统中的角色ID
- 根据实际情况调整SQL脚本中的角色ID

### 2. **菜单层级**
- 确保菜单的父级关系正确
- 注意菜单的显示顺序和层级结构

### 3. **权限测试**
- 配置完成后需要测试各角色的权限
- 确保权限验证机制正常工作

### 4. **数据安全**
- 严格控制数据访问权限
- 确保用户只能操作自己权限范围内的数据

## 🔄 权限更新维护

### 1. **新增权限**
- 在 `la_system_menu` 表中添加新的权限记录
- 更新相应角色的权限分配

### 2. **权限调整**
- 通过管理后台的角色管理功能调整权限
- 或直接修改 `la_system_role_menu` 表

### 3. **权限清理**
- 定期清理无效的权限记录
- 确保权限配置的一致性
