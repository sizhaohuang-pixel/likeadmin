# 代理商套餐分配系统路由配置

## 📋 路由配置说明

### 🔧 **ThinkPHP自动路由机制**

likeadmin项目基于ThinkPHP 8.0的多应用架构，使用**自动路由**机制，无需手动配置路由文件。路由规则遵循以下格式：

```
/应用名/控制器名/方法名
```

### 🎯 **套餐分配系统路由列表**

#### **基础路径**: `/adminapi/package/`

| 功能模块 | HTTP方法 | 路由路径 | 控制器方法 | 权限标识符 |
|---------|---------|---------|-----------|-----------|
| **核心功能** |
| 分配套餐 | POST | `/adminapi/package/assign` | `assign()` | `package/assign` |
| 租户套餐查询 | GET | `/adminapi/package/tenant-packages` | `tenantPackages()` | `package/tenant-packages` |
| 分配小号 | POST | `/adminapi/package/assign-alt-account` | `assignAltAccount()` | `package/assign-alt-account` |
| 端口可用性检查 | GET | `/adminapi/package/check-port-availability` | `checkPortAvailability()` | `package/check-port-availability` |
| 分配历史查询 | GET | `/adminapi/package/assign-history` | `assignHistory()` | `package/assign-history` |
| **管理功能** |
| 套餐列表 | GET | `/adminapi/package/lists` | `lists()` | `package/lists` |
| 统计信息 | GET | `/adminapi/package/statistics` | `statistics()` | `package/statistics` |
| 套餐详情 | GET | `/adminapi/package/detail` | `detail()` | `package/detail` |
| 端口池状态 | GET | `/adminapi/package/port-pool-status` | `portPoolStatus()` | `package/port-pool-status` |
| **系统维护** |
| 处理过期套餐 | POST | `/adminapi/package/handle-expired` | `handleExpired()` | `package/handle-expired` |
| 更新过期状态 | POST | `/adminapi/package/update-expired-status` | `updateExpiredStatus()` | `package/update-expired-status` |
| **辅助功能** |
| 租户选项 | GET | `/adminapi/package/tenant-options` | `tenantOptions()` | `package/tenant-options` |
| 客服选项 | GET | `/adminapi/package/operator-options` | `operatorOptions()` | `package/operator-options` |
| 小号选项 | GET | `/adminapi/package/alt-account-options` | `altAccountOptions()` | `package/alt-account-options` |

## 🛡️ **中间件配置**

### **adminapi应用中间件栈**

路由自动应用以下中间件（配置在 `app/adminapi/config/route.php`）：

```php
'middleware' => [
    // 初始化中间件
    app\adminapi\http\middleware\InitMiddleware::class,
    // 登录验证中间件
    app\adminapi\http\middleware\LoginMiddleware::class,
    // 权限认证中间件
    app\adminapi\http\middleware\AuthMiddleware::class,
    // 演示模式中间件
    app\adminapi\http\middleware\CheckDemoMiddleware::class,
    app\adminapi\http\middleware\EncryDemoDataMiddleware::class,
],
```

### **权限验证流程**

1. **InitMiddleware**: 初始化请求信息
2. **LoginMiddleware**: 验证用户登录状态
3. **AuthMiddleware**: 验证用户权限（基于权限标识符）
4. **CheckDemoMiddleware**: 演示模式限制
5. **EncryDemoDataMiddleware**: 演示数据加密

## 📝 **路由命名规范**

### **控制器命名**
- 文件名: `PackageController.php`
- 类名: `PackageController`
- 命名空间: `app\adminapi\controller`

### **方法命名**
- 驼峰命名法: `assignAltAccount`
- URL转换: `assign-alt-account`
- 权限标识: `package/assign-alt-account`

### **路径转换规则**
```php
// 控制器方法 → URL路径
assignAltAccount() → assign-alt-account
tenantPackages() → tenant-packages
checkPortAvailability() → check-port-availability
```

## 🔧 **路由测试方法**

### **1. 使用命令行查看路由**
```bash
# 查看所有路由
php think route:list

# 查看adminapi应用路由
php think route:list adminapi
```

### **2. API测试示例**

#### **分配套餐**
```bash
curl -X POST "http://your-domain/adminapi/package/assign" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "tenant_id": 123,
    "port_count": 100,
    "expire_days": 30,
    "remark": "测试分配"
  }'
```

#### **查询租户套餐**
```bash
curl -X GET "http://your-domain/adminapi/package/tenant-packages?tenant_id=123" \
  -H "Authorization: Bearer your-token"
```

#### **检查端口可用性**
```bash
curl -X GET "http://your-domain/adminapi/package/check-port-availability?tenant_id=123&need_count=50" \
  -H "Authorization: Bearer your-token"
```

## 🎯 **前端路由配置**

### **Vue Router配置示例**

```javascript
// 套餐管理路由配置
{
  path: '/package',
  name: 'Package',
  component: Layout,
  meta: { title: '套餐管理', icon: 'el-icon-Box' },
  children: [
    {
      path: 'assign',
      name: 'PackageAssign',
      component: () => import('@/views/package/assign/index.vue'),
      meta: { title: '套餐分配', perms: ['package/lists'] }
    },
    {
      path: 'port',
      name: 'PackagePort',
      component: () => import('@/views/package/port/index.vue'),
      meta: { title: '端口管理', perms: ['package/tenant-packages'] }
    },
    {
      path: 'history',
      name: 'PackageHistory',
      component: () => import('@/views/package/history/index.vue'),
      meta: { title: '分配历史', perms: ['package/assign-history'] }
    }
  ]
}
```

### **API调用示例**

```javascript
// API服务封装
import request from '@/utils/request'

export const packageApi = {
  // 分配套餐
  assign(data) {
    return request.post('/package/assign', data)
  },
  
  // 查询租户套餐
  getTenantPackages(params) {
    return request.get('/package/tenant-packages', { params })
  },
  
  // 分配小号
  assignAltAccount(data) {
    return request.post('/package/assign-alt-account', data)
  },
  
  // 检查端口可用性
  checkAvailability(params) {
    return request.get('/package/check-port-availability', { params })
  },
  
  // 获取套餐列表
  getList(params) {
    return request.get('/package/lists', { params })
  }
}
```

## ⚠️ **注意事项**

### **1. 路由缓存**
- 生产环境建议开启路由缓存
- 修改路由后需要清除缓存

### **2. 权限验证**
- 所有路由都会经过权限验证中间件
- 确保权限标识符与菜单配置一致

### **3. 参数验证**
- 所有接口都使用验证器进行参数验证
- 遵循场景验证模式

### **4. 错误处理**
- 统一的错误响应格式
- 详细的错误信息提示

## 🔄 **路由维护**

### **新增路由步骤**
1. 在控制器中添加新方法
2. 在权限配置中添加对应权限标识符
3. 更新前端路由配置
4. 测试路由可访问性

### **路由调试**
```bash
# 查看具体路由信息
php think route:list | grep package

# 测试路由解析
php think route:test /adminapi/package/assign POST
```

### **性能优化**
- 合理使用路由缓存
- 避免过深的路由嵌套
- 优化中间件执行顺序

## 📊 **路由统计**

| 路由类型 | 数量 | 说明 |
|---------|------|------|
| GET路由 | 9个 | 查询类接口 |
| POST路由 | 5个 | 操作类接口 |
| 总计 | 14个 | 完整功能覆盖 |

所有路由都遵循RESTful设计原则，提供完整的CRUD操作支持。
